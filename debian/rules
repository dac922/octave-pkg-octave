#!/usr/bin/make -f
# 							-*- makefile -*-
# debian/rules file for the Debian/GNU Linux octave package
# Copyright 1997-99,2000-03 by Dirk Eddelbuettel <edd@debian.org>
#
# $Id$

include /usr/share/dpatch/dpatch.make

# in order: octave, octave2.1, 2.1.28, 2.1  (or whatever the version is)
source		:= $(shell head -1 debian/changelog | \
			perl -nle 'm/^([a-z]+)/ and print $$1')
PACKAGE		:= $(shell head -1 debian/changelog | \
			perl -nle 'm/^(\S+)\s+/ and print $$1')
version       	:= $(shell head -1 debian/changelog | \
			perl -nle 'm/\S+\s+\((?:\d:)*(\S+)-\S+\)/ and print $$1')
major       	:= $(shell echo $(version) | perl -nle \
			'm/(\d\.\d)\.\d+/ and print $$1')

ifeq ($(major),2.1)
priority	:= 80
else
priority	:= 70
endif

doc_package	= $(PACKAGE)-doc
html_package	= $(PACKAGE)-htmldoc
dev_package	= $(PACKAGE)-headers
emacs_package	= $(PACKAGE)-emacsen
info_package	= $(PACKAGE)-info

debbase		:= $(CURDIR)/debian
debtmp		:= $(debbase)/$(PACKAGE)
debdoc		:= $(debtmp)/usr/share/doc/$(PACKAGE)
debhtmldoc	:= $(debtmp)-htmldoc/usr/share/doc/$(PACKAGE)-htmldoc
deblsp		:= $(debbase)/$(emacs_package)/usr/share/emacs/site-lisp/$(emacs_package)
debini		:= $(debtmp)/usr/share/octave/site/m/startup
debininew	:= $(debtmp)/usr/share/octave/$(version)/m/startup

texifiles	:= doc/interpreter/octave.texi		\
			doc/liboctave/liboctave.texi	\
			doc/faq/Octave-FAQ.texi

origdoc		:= interpreter/octave.pdf faq/Octave-FAQ.pdf \
			liboctave/liboctave.pdf

## edd  3 Feb 2003  gcc 3.2, also imposed uniformly via Build-Depends
## edd 27 Jun 2003  now that gcc 3.3 is in unstable and testing, relax this
#c_compiler	= /usr/bin/gcc-3.3
#cxx_compiler	= /usr/bin/g++-3.3
#f77_compiler	= /usr/bin/g77-3.3
c_compiler	= /usr/bin/gcc
cxx_compiler	= /usr/bin/g++
f77_compiler	= /usr/bin/gfortran
fc_flag		= --with-f77=$(f77_compiler)
fc_libs		=
compilerflags	= -O2
linkerflags	= -s

# default to blas, atlas can overload where available (see README.Atlas)
#atlas		= --with-blas=/usr/lib/libblas.so \
#		  --with-lapack=/usr/lib/liblapack.so
#atlas		= --with-blas=/usr/lib/libblas-3.so \
#		  --with-lapack=/usr/lib/liblapack-3.so
atlas		= --with-blas=-lblas-3 --with-lapack=-llapack-3

arch 		:= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)

## edd 20 Jun 2002      no optimisation or debugging on baby systems
ifneq "$(findstring $(arch), arm-linux-gnu)" ""
compilerflags	= -O0 -g0
endif

# edd 25 Aug 2002  arm does not have atlas
ifeq ($(arch),arm-linux)
atlas		= --without-blas
endif

#export DH_VERBOSE=1

sliceterm = UNDEF+V_$(shell echo $(major) | sed s/\\./_/g)

debian/control: debian/in/control
	slice -o $(sliceterm):$@ $<

maintainer-clean:
	rm -f debian/control

maintainer-scripts:
	for in in debian/in/PACKAGE* ; do \
		out=`echo $$in | sed 's:/in/:/:;s/PACKAGE/$(PACKAGE)/'` ; \
		sed 's/@VERSION@/$(version)/g;s/@PACKAGE@/$(PACKAGE)/g;s/@MAJOR@/$(major)/g;s/@PRIORITY@/$(priority)/g;' \
			< $$in > $$out ; \
	done

	for f in octave-depends defs.make ; do \
		sed 's/@VERSION@/$(version)/g;s/@MAJOR@/$(major)/g' \
			< debian/in/$$f > debian/$$f ; \
	done
	cp debian/in/$(PACKAGE)-00list debian/patches/00list
	cp debian/in/$(PACKAGE)-watch debian/watch

get-orig-source: upstream
upstream:
	links ftp://ftp.octave.org/pub/octave/bleeding-edge

build: build-stamp configure-stamp make-stamp check-stamp
build-stamp: configure make check
	touch build-stamp

configure: maintainer-scripts patch-stamp configure-stamp
configure-stamp:
	dh_testdir

        # use Debian's tempfile(1) for enhanced security
	cp octave-bug.in octave-bug.in.orig
	perl -p -i -e 's|/tmp/octave-bug.\$$\$$|`tempfile`|' octave-bug.in

	[ -f autogen.sh ] &&  ./autogen.sh && chmod 0755 configure

	DEFAULT_PAGER=pager				\
	CC=$(c_compiler) 				\
	CXX=$(cxx_compiler)				\
	F77=$(f77_compiler)				\
	FLIBS=$(fc_libs)				\
	infofile=/usr/share/info/$(PACKAGE).info	\
	./configure					\
			--prefix=/usr			\
			--datadir=/usr/share		\
			--libdir=/usr/lib		\
			--libexecdir=/usr/lib		\
			--infodir=/usr/share/info	\
			--mandir=/usr/share/man		\
			$(atlas)			\
			--with-hdf5			\
			--with-fftw			\
			$(fc_flag)			\
			--enable-shared			\
			--enable-rpath			\
			--disable-static		\
			--build $(arch)

	pod2man debian/octave-depends > octave-depends-$(version).1

	for f in $(texifiles) ; do					\
		cp $$f $$f-save ; 					\
		perl -pi -e 's/^(\@setfilename .+ctave)/$${1}$(major)/'	\
			$$f ; 						\
	done

	touch configure-stamp

make: configure-stamp make-stamp
make-stamp:


	if test ! -d doc-orig; then				\
		for f in $(origdoc); do				\
			mkdir -p doc-orig/`dirname $$f`;	\
			cp doc/$$f doc-orig/$$f ;		\
		done;						\
	fi

	$(MAKE)		CFLAGS="$(compilerflags)"		\
			CXXFLAGS="$(compilerflags)"		\
			FFLAGS="$(compilerflags)"		\
			LDFLAGS="$(linkerflags)"		\
			CC="$(c_compiler)"			\
			CXX="$(cxx_compiler)"			\
			F77="$(f77_compiler)"			\

	touch make-stamp

check: configure-stamp make-stamp check-stamp
check-stamp:
	-$(MAKE) 	check
	touch check-stamp

clean: unpatch
	dh_testdir
	dh_testroot

	find doc -name Makefile | xargs rm -f

	-$(MAKE) -i distclean || $(MAKE) -f Makefile.in distclean

	if test -d doc-orig; then			\
		for f in $(origdoc) ; do		\
			mv doc-orig/$$f doc/$$f ;	\
		done;					\
		rm -rf doc-orig ;			\
	fi

	rm -f build-stamp configure-stamp make-stamp check-stamp \
		install-stamp Makefile.tmp
	-rm -vrf libcruft/libcruft.so libcruft/*/Makefile		\
		install.octave  scripts/gethelp  libcruft/misc/*.d	\
		scripts/autom4te.cache config.log Makefrag.f77		\
		src/PKG_ADD src/pic src/*.oct src/*.df doc/*/HTML	\
		examples/octave.desktop scripts/*/PKG_ADD		\
		test/test_sparse.m doc/interpreter/munge-texi
	find doc -name \*.html -exec rm -f \{} \;
	find doc -name HTML -exec rm -rf \{} \;

	test ! -f octave-bug.in.orig || mv octave-bug.in.orig octave-bug.in

	rm -f `ls debian/in/PACKAGE* | sed 's/PACKAGE/$(PACKAGE)/;s:/in::'`
	rm -f octave-depends-$(version).1
	( cd debian ; rm -f watch octave-depends defs.make )

	dh_clean

install: configure-stamp make-stamp check-stamp install-stamp
install-stamp:
	dh_testdir
	dh_testroot
	dh_installdirs -A
	$(MAKE) INSTALL_PROGRAM="install -s" DESTDIR=$(debtmp) install
	dh_installman octave-depends-$(version).1
	install debian/octave-depends \
		 $(debtmp)/usr/bin/octave-depends-$(version)
	install --mode=644 debian/defs.make \
		$(debtmp)/usr/share/octave/debian/defs.make-$(version)
	(cd $(debtmp)/usr/share/man/man1; 				\
		mv -v	octave.1	octave-$(version).1;    	\
		ln -s	octave-$(version).1	octave$(major).1;	\
		mv -v   octave-bug.1	octave-bug-$(version).1;	\
		mv -v	octave-config.1	octave-config-$(version).1;   	\
		mv -v   mkoctfile.1	mkoctfile-$(version).1;		)
	(cd $(debtmp)/usr/bin; 						\
		rm -v   octave	octave-bug mkoctfile octave-config)
	touch install-stamp

binary-indep: build install check
	dh_testdir -i
	dh_testroot -i

	dh_installdocs -n -p$(doc_package) doc/*/*.pdf
	dh_installdocs -i
	for dir in faq interpreter liboctave ; do			\
		test -d $(debhtmldoc)/$$dir				\
			|| mkdir $(debhtmldoc)/$$dir ;			\
		find doc/$$dir \( -name \*.html -o -name \*.png \) 	\
			 -exec cp \{} $(debhtmldoc)/$$dir \; ;		\
	done

        # install Octave Emacs files and Debian Emacsen files
	dh_installdirs -p$(emacs_package)
	dh_installdirs -p$(emacs_package) \
		usr/share/emacs/site-lisp/$(emacs_package)
	install -p -m 0644 emacs/*.el		$(deblsp)
	dh_installemacsen -p$(emacs_package)
	install -p -m 0755 emacs/otags			\
		$(debbase)/$(emacs_package)/usr/bin/otags-$(version)
	install -p -m 0644 emacs/otags.1			\
	     $(debbase)/$(emacs_package)/usr/share/man/man1/otags-$(version).1

	dh_installchangelogs -i			ChangeLog
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: build install check
	dh_testdir -a
	dh_testroot -a
	dh_installdirs -p$(PACKAGE)

        # remove the /usr/share/info/dir stab
	rm -vf $(debtmp)/usr/share/info/dir

        # save the include files for the header package
	dh_movefiles -p$(dev_package) --sourcedir=debian/$(PACKAGE)	\
			usr/include/		 			\
			usr/bin/mkoctfile-$(version) 			\
			usr/bin/octave-config-$(version)		\
			usr/bin/octave-depends-$(version) 		\
			usr/share/man/man1/mkoctfile-$(version).1	\
			usr/share/man/man1/octave-config-$(version).1	\
			usr/share/man/man1/octave-depends-$(version).1	\
			usr/share/octave/debian/defs.make-$(version)
	rm -r $(debtmp)/usr/include
	rm -rf $(debtmp)/usr/share/info

	install -p -m 0644  debian/octave.conf  $(debtmp)/etc/$(PACKAGE).conf

        # install lintian overrride
	install -p -m 0644  debian/$(PACKAGE).lintian \
			$(debtmp)/usr/share/lintian/overrides/$(PACKAGE)

        ## link the conf.file back from /etc over the version.spec. rc
	ln -sf /etc/$(PACKAGE).conf 		$(debininew)/octaverc
        ## this file would exist under 2.0 and 2.1 with the same name
	rm -v 					$(debini)/octaverc
        # already installed by make
	dh_installinfo -n -p$(info_package)  	doc/*/*$(major)*.info*
	dh_installdocs -a			README README.kpathsea \
						NEWS* PROJECTS
	dh_installdocs -p$(PACKAGE) 		debian/README.Atlas
        # recreated in postinst in share/, not needed in lib
	rm -vf	$(debtmp)/usr/lib/octave/ls-R \
		$(debtmp)/usr/share/octave/ls-R

	dh_installexamples  -p$(dev_package)  	examples/*
	dh_installmenu -p$(PACKAGE)
	dh_installchangelogs -a ChangeLog ChangeLog.1
	for i in glob libcruft liboctave src scripts test doc; do \
		cp -vax $$i/ChangeLog $(debdoc)/changelog.$$i; done
	dh_link --package=$(PACKAGE) \
		usr/bin/octave-$(version) usr/bin/$(PACKAGE)
	dh_link --package=$(PACKAGE) \
		/usr/share/man/man1/octave-$(version).1.gz /usr/share/man/man1/octave$(major).1.gz
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_shlibdeps -a
	if [ `dpkg-architecture -qDEB_BUILD_ARCH` = "m68k" ];then \
		echo "m68k:Depends=f2c" >> debian/$(PACKAGE)-headers.substvars; \
	fi
	dh_gencontrol -a
	dh_builddeb -a

source diff:
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

binary: install maintainer-scripts binary-arch binary-indep
.PHONY: build clean make configure binary-indep binary-arch binary

